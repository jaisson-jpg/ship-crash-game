<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src 'self' https://fonts.gstatic.com data:; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval'; 
        img-src 'self' data: content: file:; 
        media-src *; 
        connect-src 'self' https://dd5c-2804-5b40-aa51-5d00-a5cb-c85d-8daa-980b.ngrok-free.app wss://dd5c-2804-5b40-aa51-5d00-a5cb-c85d-8daa-980b.ngrok-free.app;
    ">
    <title>Retirar DINDIN - Promotor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Poppins', sans-serif; background-color: #12122c; color: #e0e0e0; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: #1e1e3e; padding: 20px; border-radius: 10px; width: 100%; max-width: 450px; margin-top: 20px; }
        h1 { color: #8a8aff; text-align: center; margin-bottom: 20px; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; text-align: left; }
        input[type="number"], input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #5a5a8a; background-color: #2a2a4a; color: #fff; }
        button { padding: 12px 20px; border: none; border-radius: 5px; background-color: #e65a5a; /* Cor diferente para retirada */ color: white; cursor: pointer; font-weight: bold; font-size: 1em; width: 100%; transition: background-color 0.3s ease; }
        button:hover { background-color: #c74c4c; }
        .back-button { background-color: #5a5a8a; color: #e0e0e0; margin-bottom:20px; width: auto; padding: 8px 15px; }
        .back-button:hover { background-color: #6a6aff; }
        .message { margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center; }
        .message.success { background-color: #28a745; color: white; }
        .message.error { background-color: #dc3545; color: white; }
        .promoter-info { font-size: 0.9em; margin-bottom: 15px; background-color: #2a2a4a; padding: 10px; border-radius: 5px; }
        .rules { font-size: 0.8em; color: #aaa; margin-top: 15px; text-align: left; padding: 10px; background-color: #2a2a4a; border-radius: 5px;}
    </style>
</head>
<body>
    <button class="back-button" onclick="window.location.href='promotor.html'">Voltar ao Painel</button>

    <div class="container">
        <h1>Retirar DINDIN do Jogador</h1>

        <div class="promoter-info">
            Seu ID: <span id="currentPromoterId"></span> | Seu Saldo de Sistema: R$ <span id="currentPromoterBalance"></span>
        </div>

        <div>
            <label for="targetUserIdWithdraw">ID do Jogador Alvo:</label>
            <input type="number" id="targetUserIdWithdraw" placeholder="Digite o ID do jogador">
        </div>
        <div>
            <label for="amountWithdraw">Quantidade de DINDIN para Retirar:</label>
            <input type="number" id="amountWithdraw" placeholder="Digite a quantidade">
        </div>
        <button onclick="withdrawChips()">RETIRAR DINDIN</button>
        <div id="responseMessageWithdraw" class="message" style="display: none;"></div>
        <div class="rules">
            <strong>Atenção:</strong><br>
            - O jogador precisa ser VIP >= 1 ou Nível >= 10 (Lógica a ser implementada no backend).<br>
            - Retirada mínima: 10 DINDIN.
        </div>
    </div>

    <script>
        // Chaves do localStorage
        const backendUrl = 'https://dd5c-2804-5b40-aa51-5d00-a5cb-c85d-8daa-980b.ngrok-free.app'; // <<< IMPORTANTE: ATUALIZE ESTA URL
        const promoterIdKey = 'crashGameUserId'; 
        const promoterBalanceKey = 'crashGamePlayerBalance'; 
        const authTokenKey = 'crashGameAuthToken'; 
        const userRoleKey = 'crashGameUserRole';

        // Elementos da DOM
        const currentPromoterIdEl = document.getElementById('currentPromoterId');
        const currentPromoterBalanceEl = document.getElementById('currentPromoterBalance');
        const targetUserIdInput = document.getElementById('targetUserIdWithdraw');
        const amountInput = document.getElementById('amountWithdraw');
        const responseMessageEl = document.getElementById('responseMessageWithdraw');

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem(authTokenKey);
            const role = localStorage.getItem(userRoleKey);

            if (!token || role !== 'promoter') {
                console.log("RETIRAR DINDIN: Usuário não é promotor ou não está logado. Redirecionando...");
                window.location.href = 'index.html';
                return;
            }
            loadPromoterInfo();
        });

        function loadPromoterInfo() {
            const promoterId = localStorage.getItem(promoterIdKey);
            const promoterBalance = localStorage.getItem(promoterBalanceKey);

            if (currentPromoterIdEl && promoterId) {
                currentPromoterIdEl.textContent = promoterId;
            }
            if (currentPromoterBalanceEl && promoterBalance !== null) {
                currentPromoterBalanceEl.textContent = parseFloat(promoterBalance).toFixed(2);
            } else if (currentPromoterBalanceEl) {
                currentPromoterBalanceEl.textContent = "0.00";
            }
        }

        async function withdrawChips() {
            const promoterId = localStorage.getItem(promoterIdKey);
            const targetUserId = targetUserIdInput.value;
            const amount = amountInput.value;
            // const token = localStorage.getItem(authTokenKey); // Para autenticação futura

            responseMessageEl.style.display = 'none';
            responseMessageEl.textContent = '';
            responseMessageEl.className = 'message';

            if (!targetUserId || !amount || parseFloat(amount) <= 0) {
                showMessage('Por favor, preencha o ID do jogador e uma quantidade válida.', 'error');
                return;
            }
            if (parseFloat(amount) < 10) { // Validação mínima no cliente também
                showMessage('Valor mínimo para retirada é 10 DINDIN.', 'error');
                return;
            }


            console.log(`Tentando retirar ${amount} DINDIN do jogador ${targetUserId} para o promotor ${promoterId}`);

            try {
                const response = await fetch(`${backendUrl}/api/promoter/withdraw-chips`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ 
                        promoterId: parseInt(promoterId), 
                        targetUserId: parseInt(targetUserId), 
                        amount: parseFloat(amount) 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message || 'Fichas retiradas com sucesso!', 'success');
                    if (data.promoterNewBalance !== undefined) {
                        localStorage.setItem(promoterBalanceKey, data.promoterNewBalance.toString());
                        loadPromoterInfo(); 
                    }
                    // Não necessariamente limpamos os campos aqui, pode ser útil manter para nova operação.
                    // targetUserIdInput.value = ''; 
                    // amountInput.value = '';      
                } else {
                    showMessage(data.error || 'Erro ao retirar fichas.', 'error');
                }
            } catch (error) {
                console.error('Erro na requisição de retirada de fichas:', error);
                showMessage('Erro de comunicação ao retirar fichas. Tente novamente.', 'error');
            }
        }

        function showMessage(message, type) {
            responseMessageEl.textContent = message;
            responseMessageEl.className = `message ${type}`;
            responseMessageEl.style.display = 'block';
        }
    </script>
</body>
</html>